name: Deploy Micser-1-ASP
on:
 workflow_call:  
    inputs:
      image-tag:
        description: 'Image tag to deploy'
        required: true
        type: string
        default: 'latest'
  workflow_dispatch:
    inputs:
      image-tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
  workflow_run:
    workflows: ["Build ASP.NET"]
    types: [completed]

env:
  SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  COMPOSE_PROJECT_NAME: tbank-app

jobs:
  deploy-micser-ASP:
    #needs: build-and-push-micser-ASP
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          docker-compose.yml
          .env.example

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Test SSH connection
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "echo 'SSH connection successful!'"

    - name: Create app directory on server
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        mkdir -p ~/app
        echo 'App directory created successfully'
        "
    - name: Create wwwroot directory on server
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        mkdir -p ~/app/wwwroot
        echo 'App directory created successfully'
        "

    - name: Create Image directory on server
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        mkdir -p ~/app/wwwroot/Image
        echo 'App directory created successfully'
        "
    - name: Create NONE directory on server
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
        mkdir -p ~/app/wwwroot/NONE
        echo 'App directory created successfully'
        "


    - name: Copy nginx-dockerfile
      run: |
        scp Dockerfile ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/app/
        
    - name: Copy nginx-conf
      run: |
        scp nginx.conf ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/app/        

    - name: Copy docker-compose.yml to server
      run: |
        scp docker-compose.yml ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/app/

    - name: Copy environment file if exists
      run: |
        if [ -f ".env.example" ]; then
          scp .env.example ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:~/app/
        fi

    - name: Deploy with Docker Compose
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd ~/app
          
          # Login to GitHub Container Registry
          echo 'Logging in to GitHub Container Registry...'
          echo '${{ secrets.GITHUB_TOKEN }}' | docker login ${{ env.REGISTRY }} -u '${{ github.actor }}' --password-stdin
          
          # Create .env file from example if it doesn't exist
          if [ ! -f .env ] && [ -f .env.example ]; then
            cp .env.example .env
            echo 'Created .env file from example'
          fi
          
          # Pull the latest images
          echo 'Pulling latest Docker images...'
          docker compose pull
          
          # Start services with Docker Compose
          echo 'Starting services with Docker Compose...'
          docker compose up -d
          
          # Check service status
          echo 'Checking service status...'
          docker compose ps
          
          # Clean up unused images
          echo 'Cleaning up...'
          docker image prune -f
        "