syntax = "proto3";

option csharp_namespace = "AlalysisService";
package analysis.v1;


service AnalysisService {
  rpc UploadImage(stream UploadImageRequest) returns (UploadImageResponse);
}

message UploadImageRequest {
  // client MUST first send `Metadata`, then chunks
  oneof image {
    Metadata metadata = 1;
    bytes data = 2;
  }
}

message Metadata {
  ImageMetadata image = 1;
  UserMetadata user = 2;
}

message ImageMetadata {
  uint64 image_id = 1;
  FileType file_type = 2;
}

message UserMetadata {
  uint32 age = 1;
  uint32 weight = 2;
  uint32 height = 3;
  Sex sex = 4;
  string details = 5;
}

enum Sex {
  SEX_UNSPECIFIED = 0;
  SEX_MALE = 1;
  SEX_FEMALE = 2;
}

// can be extended later
enum FileType {
  FILE_TYPE_UNSPECIFIED = 0;
  FILE_TYPE_JPEG = 1;
  FILE_TYPE_PNG = 2;
}

message UploadImageResponse {
  oneof response {
    AnalysisResult result = 1;
    UploadImageError error = 2;
  }
}

message AnalysisResult {
  uint64 image_id = 1;

  // probabilities of each of this diseases
  float acne = 2;
  float actinic_keratosis = 3;
  float basal_cell_carcinoma = 4;
  float eczema = 5;
  float rosacea = 6;
}

message UploadImageError {
  UploadImageErrorCode code = 1;
  // may be ignored by the client if needed, provides additional details about error
  string message = 2;
}

// can be extended later, will be backwards-compatible
enum UploadImageErrorCode {
  // service doesn't know the error
  UPLOAD_IMAGE_ERROR_CODE_UNSPECIFIED = 0;
  // service knows the error
  UPLOAD_IMAGE_ERROR_CODE_INTERNAL_ERROR = 1;
  UPLOAD_IMAGE_ERROR_CODE_INVALID_METADATA = 2;
  UPLOAD_IMAGE_ERROR_CODE_UNKNOWN_FILE_TYPE = 3;
}
